version: 1
backend:
  phases:
    build:
      commands:
        - '# Execute Amplify CLI with the helper script'
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --force
        - '#install su'
        - '#install shasum'
        - '# sudo yum update'
        - '# sudo yum install perl-Digest-SHA'
        - '# shasum -v'
        - '# download Codecov CLI'
        - curl -Os https://cli.codecov.io/latest/linux/codecov

        - '# integrity check'
        - curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import # One-time step  
        - curl -Os https://cli.codecov.io/latest/linux/codecov
        - curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
        - curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
        - gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
        
        - sha256sum -c codecov.SHA256SUM
        - sudo chmod +x codecov
        - ./codecov --help
    build:
      commands:
        - npm run build-prod
  artifacts:
    baseDirectory: build
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
test:
  phases:
    preTest:
      commands:
        - sudo yum install -y jq unzip wget yum-utils
        - wget -q -O /tmp/google-signing-key.pub https://dl.google.com/linux/linux_signing_key.pub
        - sudo rpm --import /tmp/google-signing-key.pub
        - sudo yum-config-manager --add-repo https://dl.google.com/linux/chrome/rpm/stable/x86_64
        - sudo yum install -y google-chrome-stable
        - google-chrome --version
        - npm install mocha mochawesome mochawesome-merge mochawesome-report-generator
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then npm ci; fi
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then npm install -g pm2; fi
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then npm install -g wait-on; fi
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then pm2 start npm -- start; fi
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then wait-on http://localhost:3000; fi
    test:
      commands:
        - if [ "${ENABLE_REGRESSION}" = "false" ]; then npx cypress run --component --browser chrome --reporter mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss" --config video=false; fi
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then npx cypress run --browser chrome --reporter  mochawesome --reporter-options "reportDir=cypress/report/mochawesome-report,overwrite=false,html=false,json=true,timestamp=mmddyyyy_HHMMss"; fi
    postTest:
      commands:
        - npx mochawesome-merge cypress/report/mochawesome-report/mochawesome*.json > cypress/report/mochawesome.json
        - cp cypress/report/mochawesome.json .
        - ./codecov upload-process -f mochawesome.json -t ${CODECOV_TOKEN}
        - if [ "${ENABLE_REGRESSION}" = "true" ]; then pm2 kill; fi
  artifacts:
    baseDirectory: cypress
    configFilePath: '**/mochawesome.json'
    files:
      - '**/*.png'
      - '**/*.mp4'
      - '**/coverage/*.*'